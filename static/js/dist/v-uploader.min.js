(function(){'use strict';var moduleName="UploaderCommon";try{angular.module(moduleName);return}catch(e){}var module=angular.module(moduleName,[]);module.factory('$UploaderUtil',function(){return{secondsToStr(temp){const years=Math.floor(temp/31536000);if(years){return years+' year'+numberEnding(years)}const days=Math.floor((temp%=31536000)/86400);if(days){return days+' day'+numberEnding(days)}const hours=Math.floor((temp%=86400)/3600);if(hours){return hours+' hour'+numberEnding(hours)}const minutes=Math.floor((temp%=3600)/60);if(minutes){return minutes+' minute'+numberEnding(minutes)}const seconds=temp%60;return seconds+' second'+numberEnding(seconds);function numberEnding(number){return(number>1)?'s':''}},kebabCase(s){return s.replace(/[A-Z]/g,(m)=>`-${m.toLowerCase()}`)},};});module.factory('$UploaderMixins',function(){return{uploader:{inject:['uploader']},support:{data(){return{support:true}},mounted(){this.support=this.uploader.uploader.support}},};});module.factory('$UploaderEvents',function(){return['fileProgress','fileSuccess','fileComplete','fileError']});}());(function(){'use strict';var moduleName="UploaderBtn";try{angular.module(moduleName);return}catch(e){}var module=angular.module(moduleName,['UploaderCommon']);module.factory('$UploaderBtn',function($UploaderMixins){const props={directory:{type:Boolean,default:false},single:{type:Boolean,default:false},attrs:{type:Object,default(){return{}}}};const util={};const methods={Click(){}};const data=function(){let vm=this};const mounted=function(){this.$nextTick(()=>{this.uploader.uploader.assignBrowse(this.$refs.btn,this.directory,this.single,this.attrs)})};let template=parcelRequire('js/c/uploader/btn.vue.html');var $Компонент={props,mixins:[$UploaderMixins.uploader,$UploaderMixins.support],methods,mounted,render:template.render,staticRenderFns:template.staticRenderFns,};const $Конструктор=function(){let $this=this;return $Компонент};return $Конструктор});}());(function(){'use strict';var moduleName="UploaderDrop";try{angular.module(moduleName);return}catch(e){}var module=angular.module(moduleName,['UploaderCommon']);module.factory('$UploaderDrop',function($UploaderMixins){const props={};const util={};const methods={onDragEnter(){this.dropClass='uploader-dragover'},onDragLeave(){this.dropClass=''},onDrop(){this.dropClass='uploader-droped'},};const data=function(){let vm=this;return{dropClass:'',}};const mounted=function(){this.$nextTick(()=>{const dropEle=this.$refs.drop;const uploader=this.uploader.uploader;uploader.assignDrop(dropEle);uploader.on('dragenter',this.onDragEnter);uploader.on('dragleave',this.onDragLeave);uploader.on('drop',this.onDrop)})};const beforeDestroy=function(){const dropEle=this.$refs.drop;const uploader=this.uploader.uploader;uploader.off('dragenter',this.onDragEnter);uploader.off('dragleave',this.onDragLeave);uploader.off('drop',this.onDrop);uploader.unAssignDrop(dropEle)};let template=parcelRequire('js/c/uploader/drop.vue.html');var $Компонент={props,mixins:[$UploaderMixins.uploader,$UploaderMixins.support],data,methods,mounted,beforeDestroy,render:template.render,staticRenderFns:template.staticRenderFns,};const $Конструктор=function(){let $this=this;return $Компонент};return $Конструктор});}());(function(){'use strict';var moduleName="UploaderFile";try{angular.module(moduleName);return}catch(e){}var module=angular.module(moduleName,['UploaderCommon']);module.factory('$UploaderFile',function($UploaderEvents,$UploaderUtil){const props={file:{type:Object,default(){return{}},},list:{type:Boolean,default:false,},};const util={};const methods={_actionCheck(){this.paused=this.file.paused;this.error=this.file.error;this.isUploading=this.file.isUploading()},pause(){this.file.pause();this._actionCheck();this._fileProgress()},resume(){this.file.resume();this._actionCheck()},remove(){this.file.cancel()},retry(){this.file.retry();this._actionCheck()},processResponse(message){let res=message;try{res=JSON.parse(message)}catch(e){}this.response=res},fileEventsHandler(event,args){const rootFile=args[0];const file=args[1];const target=this.list?rootFile:file;if(this.file===target){if(this.list&&event==='fileSuccess'){this.processResponse(args[2]);return}this[`_${event}`].apply(this,args)}},_fileProgress(){this.progress=this.file.progress();this.averageSpeed=this.file.averageSpeed;this.currentSpeed=this.file.currentSpeed;this.timeRemaining=this.file.timeRemaining();this.uploadedSize=this.file.sizeUploaded();this._actionCheck()},_fileSuccess(rootFile,file,message){if(rootFile){this.processResponse(message)}this._fileProgress();this.error=false;this.isComplete=true;this.isUploading=false},_fileComplete(){this._fileSuccess()},_fileError(rootFile,file,message){this._fileProgress();this.processResponse(message);this.error=true;this.isComplete=false;this.isUploading=false},};const data=function(){let vm=this;return{response:null,paused:false,error:false,averageSpeed:0,currentSpeed:0,isComplete:false,isUploading:false,size:0,formatedSize:'',uploadedSize:0,progress:0,timeRemaining:0,type:'',extension:'',progressingClass:'',}};const computed={fileCategory(){const extension=this.extension;const isFolder=this.file.isFolder;let type=isFolder?'folder':'unknown';const categoryMap=this.file.uploader.opts.categoryMap;const typeMap=categoryMap||{image:['gif','jpg','jpeg','png','bmp','webp'],video:['mp4','m3u8','rmvb','avi','swf','3gp','mkv','flv'],audio:['mp3','wav','wma','ogg','aac','flac'],document:['doc','txt','docx','pages','epub','pdf','numbers','csv','xls','xlsx','keynote','ppt','pptx']};Object.keys(typeMap).forEach((_type)=>{const extensions=typeMap[_type];if(extensions.indexOf(extension)>-1){type=_type}});return type},progressStyle(){const progress=Math.floor(this.progress*100);const style=`translateX(${Math.floor(progress-100)}%)`;return{progress:`${progress}%`,webkitTransform:style,mozTransform:style,msTransform:style,transform:style,}},formatedAverageSpeed(){return`${Uploader.utils.formatSize(this.averageSpeed)}/s`},status(){const isUploading=this.isUploading;const isComplete=this.isComplete;const isError=this.error;const paused=this.paused;if(isComplete){return'success'}else if(isError){return'error'}else if(isUploading){return'uploading'}else if(paused){return'paused'}else{return'waiting'}},statusText(){const status=this.status;const fileStatusText=this.file.uploader.fileStatusText;let txt=status;if(typeof fileStatusText==='function'){txt=fileStatusText(status,this.response)}else{txt=fileStatusText[status]}return txt||status},formatedTimeRemaining(){const timeRemaining=this.timeRemaining;const file=this.file;if(timeRemaining===Number.POSITIVE_INFINITY||timeRemaining===0){return''}let parsedTimeRemaining=$UploaderUtil.secondsToStr(timeRemaining);const parseTimeRemaining=file.uploader.opts.parseTimeRemaining;if(parseTimeRemaining){parsedTimeRemaining=parseTimeRemaining(timeRemaining,parsedTimeRemaining)}return parsedTimeRemaining},};const watch={status(newStatus,oldStatus){if(oldStatus&&newStatus==='uploading'&&oldStatus!=='uploading'){this.tid=setTimeout(()=>{this.progressingClass='uploader-file-progressing'},200)}else{clearTimeout(this.tid);this.progressingClass=''}},};const mounted=function(){const staticProps=['paused','error','averageSpeed','currentSpeed'];const fnProps=['isComplete','isUploading',{key:'size',fn:'getSize'},{key:'formatedSize',fn:'getFormatSize'},{key:'uploadedSize',fn:'sizeUploaded'},'progress','timeRemaining',{key:'type',fn:'getType'},{key:'extension',fn:'getExtension'}];staticProps.forEach(prop=>{this[prop]=this.file[prop]});fnProps.forEach((fnProp)=>{if(typeof fnProp==='string'){this[fnProp]=this.file[fnProp]()}else{this[fnProp.key]=this.file[fnProp.fn]()}});const handlers=this._handlers={};const eventHandler=(event)=>{handlers[event]=(...args)=>{this.fileEventsHandler(event,args)};return handlers[event]};$UploaderEvents.forEach((event)=>{this.file.uploader.on(event,eventHandler(event))})};const destroyed=function(){$UploaderEvents.forEach((event)=>{this.file.uploader.off(event,this._handlers[event])});this._handlers=null};let template=parcelRequire('js/c/uploader/file.vue.html');var $Компонент={props,data,methods,computed,watch,mounted,destroyed,render:template.render,staticRenderFns:template.staticRenderFns,};const $Конструктор=function(){let $this=this;return $Компонент};return $Конструктор});}());(function(){'use strict';var moduleName="UploaderFiles";try{angular.module(moduleName);return}catch(e){}var module=angular.module(moduleName,['UploaderFile','UploaderCommon']);module.factory('$UploaderFiles',function($UploaderFile,$UploaderMixins){const props={};const util={};const methods={};const data=function(){let vm=this};const mounted=function(){};const computed={files(){return this.uploader.files}};let template=parcelRequire('js/c/uploader/files.vue.html');var $Компонент={mixins:[$UploaderMixins.uploader],computed,"components":{},render:template.render,staticRenderFns:template.staticRenderFns,};const $Конструктор=function(){let $this=this;$Компонент.components['uploader-file']=new $UploaderFile();return $Компонент};return $Конструктор});}());(function(){'use strict';var moduleName="UploaderList";try{angular.module(moduleName);return}catch(e){}var module=angular.module(moduleName,['UploaderFile','UploaderCommon']);module.factory('$UploaderList',function($UploaderFile,$UploaderMixins){const props={};const util={};const methods={};const data=function(){let vm=this};const computed={fileList(){return this.uploader.fileList}};let template=parcelRequire('js/c/uploader/list.vue.html');var $Компонент={mixins:[$UploaderMixins.uploader],computed,components:{},render:template.render,staticRenderFns:template.staticRenderFns,};const $Конструктор=function(){let $this=this;$Компонент.components['uploader-file']=new $UploaderFile();return $Компонент};return $Конструктор});}());(function(){'use strict';var moduleName="Uploader";try{angular.module(moduleName);return}catch(e){}var module=angular.module(moduleName,['UploaderCommon','UploaderBtn','UploaderDrop','UploaderList','UploaderFiles','UploaderFile',]);module.factory('$Uploader',function($UploaderUtil,$UploaderBtn,$UploaderDrop,$UploaderList,$UploaderFiles,$UploaderFile){const FILE_ADDED_EVENT='fileAdded';const FILES_ADDED_EVENT='filesAdded';const UPLOAD_START_EVENT='uploadStart';const provide=function(){return{uploader:this,}};const props={options:{type:Object,default(){return{}},},autoStart:{type:Boolean,default:true,},fileStatusText:{type:[Object,Function],default(){return{success:'success',error:'error',uploading:'uploading',paused:'paused',waiting:'waiting',}}},};const methods={uploadStart(){this.started=true},fileAdded(file){this.$emit($UploaderUtil.kebabCase(FILE_ADDED_EVENT),file);if(file.ignored){return false}},filesAdded(files,fileList){this.$emit($UploaderUtil.kebabCase(FILES_ADDED_EVENT),files,fileList);if(files.ignored||fileList.ignored){return false}},fileRemoved(file){this.files=this.uploader.files;this.fileList=this.uploader.fileList},filesSubmitted(files,fileList){this.files=this.uploader.files;this.fileList=this.uploader.fileList;if(this.autoStart){this.uploader.upload()}},allEvent(...args){const name=args[0];const EVENTSMAP={[FILE_ADDED_EVENT]:true,[FILES_ADDED_EVENT]:true,[UPLOAD_START_EVENT]:'uploadStart',};const handler=EVENTSMAP[name];if(handler){if(handler===true){return}this[handler].apply(this,args.slice(1))}args[0]=$UploaderUtil.kebabCase(name);this.$emit.apply(this,args)},};const data=function(){let vm=this;return{started:false,files:[],fileList:[],}};const created=function(){this.options.initialPaused=!this.autoStart;const uploader=new Uploader(this.options);this.uploader=uploader;this.uploader.fileStatusText=this.fileStatusText;uploader.on('catchAll',this.allEvent);uploader.on(FILE_ADDED_EVENT,this.fileAdded);uploader.on(FILES_ADDED_EVENT,this.filesAdded);uploader.on('fileRemoved',this.fileRemoved);uploader.on('filesSubmitted',this.filesSubmitted)};const destroyed=function(){const uploader=this.uploader;uploader.off('catchAll',this.allEvent);uploader.off(FILE_ADDED_EVENT,this.fileAdded);uploader.off(FILES_ADDED_EVENT,this.filesAdded);uploader.off('fileRemoved',this.fileRemoved);uploader.off('filesSubmitted',this.filesSubmitted);this.uploader=null};const mounted=function(){};let template=parcelRequire('js/c/uploader/uploader.vue.html');var $Компонент={provide,props,data,methods,created,destroyed,mounted,components:{},render:template.render,staticRenderFns:template.staticRenderFns,};const $Конструктор=function(){let $this=this;$Компонент.components['uploader-btn']=new $UploaderBtn();$Компонент.components['uploader-drop']=new $UploaderDrop();$Компонент.components['uploader-list']=new $UploaderList();$Компонент.components['uploader-files']=new $UploaderFiles();$Компонент.components['uploader-file']=new $UploaderFile();return $Компонент};return $Конструктор});}());(function(){'use strict';var moduleName="Uploader::Файлы";try{angular.module(moduleName);return}catch(e){}var module=angular.module(moduleName,['Uploader','Файлы::Просмотр']);module.factory('$КомпонентФайлы',function($http,$window,appRoutes,$AppUser,$Uploader,$КомпонентПросмотрФайла){const props={"folders":{type:Array,},"parent":{type:Object,},"param":{type:Object,default:function(){return{}},},};const util={};const methods={Uploads(){var vm=this;return $http.get(appRoutes.urlFor('файлы',[vm.parent.id])).then(function(resp){vm.uploads.splice(0);vm.uploads.push(...resp.data);vm['перемещение'].splice(0);vm.TopFolders();vm.ready=true},function(){Materialize.toast('Ошибка получения файлов',10000,'red-text text-darken-3 red lighten-3 fw500 border animated flash fast')})},InitUploader(){var vm=this;vm.uploader={"options":{"target":appRoutes.urlFor('выгрузить файл'),testChunks:false,"simultaneousUploads":1,"chunkSize":5*1024*1024,"generateUniqueIdentifier":function(){return Math.random().toString().match(/(\d{2,})/)[0]},"processParams":function(params,file){params.lastModified=file.file.lastModified;if(vm.parent.id)params.parent_id=vm.parent.id;return params},"parseTimeRemaining":function(timeRemaining,parsedTimeRemaining){return parsedTimeRemaining.replace(/\syears?/,'л.').replace(/\days?/,'дн.').replace(/\shours?/,'час.').replace(/\sminutes?/,'мин.').replace(/\sseconds?/,'сек.')}},statusText:{success:'Успешно сохранено',error:'Ошибка загрузки',uploading:'Загружается...',paused:'Остановлено',waiting:'Ожидание',},}},FileAdded(file){if(this.topFolder)file.relativePath=this.topFolder.name+'/'+file.relativePath},FileSuccess(rootFile,file,message,chunk){var vm=this;console.log('file success: ',file.uploader.files.indexOf(file),file.uploader.fileList.indexOf(rootFile),rootFile===file||rootFile,file.uploader);var isSingleFile=rootFile===file;file.uploader.files.removeOf(file);file.uploader.fileList.removeOf(rootFile);var resp=JSON.parse(message);if(resp.success){resp.success._file=file;if(resp.success['$last_modified/json'])resp.success.$last_modified=JSON.parse(resp.success['$last_modified/json']);if(resp.success['$ts/json'])resp.success.$ts=JSON.parse(resp.success['$ts/json']);delete resp.success['$last_modified/json'];setTimeout(()=>{vm.uploads.push(resp.success);vm.TopFolders();if(resp.success.names&&resp.success.names.length>1)vm.topFolder=vm.FindTopFolder(resp.success.names[0]);console.log("Save file",resp.success)});Materialize.toast("Сохранено успешно",3000,'green-text text-darken-3 green lighten-3 fw500 border animated zoomInUp fast')}},Size(file){return Uploader.utils.formatSize(file.size).replace(/bytes/,'б').replace(/KB/,'Кб').replace(/MB/,'Мб').replace(/GB/,'Гб')},ConfirmRemove(file){var vm=this;vm.confirmFile=file;$('#modal-confirm-remove',$(vm.$el)).modal('open')},Remove(file){var vm=this;vm.cancelerHttp=$http.post(appRoutes.urlFor('удалить файлы'),[file.id]).then(function(resp){vm.cancelerHttp=undefined;if(resp.data.error)return Materialize.toast(resp.data.error,7000,'red-text text-darken-3 red lighten-3 fw500 border animated flash fast');resp.data.map(function(r){if(r.error)return Materialize.toast(r.error,7000,'red-text text-darken-3 red lighten-3 fw500 border animated flash fast');else{Materialize.toast('Удалено успешно',3000,'green-text text-darken-3 green lighten-3 fw500 border animated zoomInUp slow');vm.uploads.removeOf(file);vm.TopFolders();if(file.names.length>1)vm.topFolder=vm.FindTopFolder(file.names[0])}});},function(resp){Materialize.toast("Ошибка удаления файла "+resp.status+" - "+resp.statusText,7000,'red-text text-darken-3 red lighten-3 fw500 border animated flash fast');vm.cancelerHttp=undefined});vm.confirmFile=undefined},FileAttachment(file){$window.location.href=appRoutes.url_for('файл-прикрепление',file.sha1)},ModalComplete(){this.confirmFile=undefined;this.iframeFile=undefined},TopFolders(){let vm=this;if(!vm.folders)return;let folders=vm.folders.reduce((a,name)=>{a[name]=0;return a},{});vm.uploads.reduce((a,file)=>{if(file.names.length==1)return a;if(!a[file.names[0]])a[file.names[0]]=0;a[file.names[0]]++;return a},folders);vm.topFolders.splice(0);vm.topFolders.push(...Object.keys(folders).map((name)=>{return{name,"файлов":folders[name],"_id":Math.random(),}}))},FindTopFolder(top){return this.topFolders.find((fd)=>fd.name==top)},AddFolder(){let f={'_edit':'','_new':true};this.topFolders.unshift(f);this.TabFolder(f);this.FocusEditFolder()},TabFolder(f){this.filterEmptyFolder=false;if(!!this['перемещение']&&this['перемещение'].length)return this.SaveFolder({"edit":this.topFolder===f?'':f.name,"@id":this['перемещение'].map(f=>f.id)}).then(function(data){Materialize.toast('Успешно перемещены файл(ы): '+data.length,3000,'green-text text-darken-3 green lighten-3 fw500 border animated zoomInUp slow')});if(this.topFolder===f)return this.topFolder=undefined;this.topFolder=f},BlurEditFolder(f){let vm=this;if(!!f._name&&!!f._edit&&f._name!=f._edit&&!!f['файлов']){vm.SaveFolder({"name":f._name,"edit":f._edit,"parent_id":vm.parent.id}).then(function(data){Materialize.toast('Успешно переименована папка',3000,'green-text text-darken-3 green lighten-3 fw500 border animated zoomInUp slow')})}else if(!!f._edit)vm.$set(f,'name',f._edit);else if(!f._name){vm.topFolders.removeOf(f);vm.topFolder=undefined}else vm.$set(f,'name',f._name);Vue.delete(f,'_edit');Vue.delete(f,'_name');},SaveFolder(param){let vm=this;return $http.post(appRoutes.urlFor('файлы/переименовать'),param).then(function(resp){if(resp.data.success){vm.ready=false;vm.Uploads().then(function(){vm.topFolder=vm.FindTopFolder(param.edit)});return resp.data.success}},function(){Materialize.toast('Ошибка сохранения папки',7000,'red-text text-darken-3 red lighten-3 fw500 border animated flash fast')})},EditFolder(f){this.$set(f,'_edit',f.name);f._name=f.name;f.name=undefined;this.FocusEditFolder()},FocusEditFolder(){setTimeout(_=>{this.$el.querySelector('input[name="edit-folder"]').focus()})},ToggleMove(file){let idx=this['перемещение'].indexOf(file);if(idx==-1){this.$set(file,'_move',true);this['перемещение'].push(file)}else{this.$set(file,'_move',false);this['перемещение'].splice(idx,1)}},SortUploads(a,b){return a.names.join('').localeCompare(b.names.join(''))},EditFile(file){let name=file.names[file.names.length-1].split(/\./);let e=name.length>1?1:0;this.$set(file,'_edit',name.slice(0,name.length-e).join('.'));this.$set(file,'_ext',name[name.length-e]);this.FocusEditFile(file)},BlurEditFile(file){let edit=file._edit+(file._ext?'.'+file._ext:'');if(file.names[file.names.length-1]!=edit){file.names[file.names.length-1]=edit;this.SaveFile(file)}Vue.delete(file,'_edit');Vue.delete(file,'_ext')},FocusEditFile(file){setTimeout(_=>{this.$el.querySelector(`#file-${file.id}input[type=text]`).focus()})},SaveFile(file){let vm=this;return $http.post(appRoutes.urlFor('файлы/переименовать'),{"id":file.id,"names":file.names}).then(function(resp){if(resp.data.success){Materialize.toast('Успешно переименован файл',3000,'green-text text-darken-3 green lighten-3 fw500 border animated zoomInUp slow');}},function(){Materialize.toast('Ошибка сохранения папки',7000,'red-text text-darken-3 red lighten-3 fw500 border animated flash fast')})},UploadsReduceByTopFolder(a,file){if(file.names.length>1&&file.names[0]==(this.topFolder.name||this.topFolder._name))a.push(file);return a},UploadsReduceByEmptyFolder(a,file){if(file.names.length==1)a.push(file);return a},ViewIframe(file){this.iframeFile=file}};const computed={UploadsLen(){return this.uploads.length},UploadsFiltered(){this.uploadsFilteredKey=Math.random();if(this.filterEmptyFolder)return this.uploads.reduce(this.UploadsReduceByEmptyFolder,[]).sort(this.SortUploads);if(this.topFolder===undefined)return this.uploads.sort(this.SortUploads);return this.uploads.reduce(this.UploadsReduceByTopFolder,[]).sort(this.SortUploads)},UploadsFilteredLen(){return this.UploadsFiltered.length},};const data=function(){let vm=this;if(!vm.parent._uploads)vm.parent._uploads=[];vm.Uploads();vm.InitUploader();vm.$AppUser=$AppUser;vm.appRoutes=appRoutes;return{ready:false,"topFolders":[],"topFolder":undefined,uploads:vm.parent._uploads,expandUploads:false,confirmFile:undefined,iframeFile:undefined,"перемещение":[],"uploadsFilteredKey":undefined,"filterEmptyFolder":false,}};const mounted=function(){var vm=this;vm.$nextTick(()=>{$('.modal',$(vm.$el)).modal({"complete":vm.ModalComplete});})};let template=parcelRequire('js/c/uploader/файлы.vue.html');var $Компонент={props,data,methods,computed,mounted,components:{},render:template.render,staticRenderFns:template.staticRenderFns,};const $Конструктор=function(ext){let $this=this;$Компонент.components['v-uploader']=new $Uploader();$Компонент.components['v-view-file-iframe']=new $КомпонентПросмотрФайла();if(ext)return jQuery.extend(true,{},$Компонент,ext);return $Компонент};return $Конструктор});}());